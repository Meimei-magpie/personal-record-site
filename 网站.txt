#é¡¹ç›®ç»“æ„#
/personal-record-site
    /backend
        server.js
    /frontend
        /src
            /components
                Editor.js
                ImageUploader.js
                WorldMap.js
                UserProfile.js
            App.js
            index.js
    package.json
#åˆ›å»ºREACTé¡¹ç›®#
npx create-react-app frontend
cd frontend
npm install react-quill leaflet react-leaflet react-filepond filepond

#APP.JS#
import React from 'react';
import WorldMap from './components/WorldMap';
import UserProfile from './components/UserProfile';
import Editor from './components/Editor';
import ImageUploader from './components/ImageUploader';
import React, { useEffect } from 'react';

function App() {
 useEffect(() => {
    console.log('ğŸš€ Appç»„ä»¶å·²åŠ è½½ï¼');
    console.log('ğŸ“ ç¯å¢ƒå˜é‡ REACT_APP_API_URL:', process.env.REACT_APP_API_URL);
    console.log('ğŸ“ æ‰€æœ‰ç¯å¢ƒå˜é‡:', process.env);
    
    // æ·»åŠ ä¸€ä¸ªæ˜æ˜¾çš„é”™è¯¯ä¿¡æ¯æµ‹è¯•
    console.error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯ä¿¡æ¯ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼');
  }, []);
useEffect(() => {
    console.log('ç¯å¢ƒå˜é‡ REACT_APP_API_URL:', process.env.REACT_APP_API_URL);
    console.log('æ‰€æœ‰REACT_APPå¼€å¤´çš„å˜é‡:', 
      Object.keys(process.env).filter(key => key.startsWith('REACT_APP_')));
  }, []);
  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100vh' }}>
      <WorldMap />
      <div style={{ position: 'absolute', top: '20px', left: '20px', color: 'white' }}>
        <h1>ä¸ªäººè®°å½•å®è§‚ä¿¡æ¯</h1>
      </div>
      <div style={{ position: 'absolute', top: '100px', left: '20px', color: 'white' }}>
        <h2>ä¸ªäººä»‹ç»</h2>
        <UserProfile />
      </div>
      <div style={{ position: 'absolute', top: '300px', left: '20px', color: 'white' }}>
        <h2>å®è§‚è§£è¯»</h2>
        <Editor />
      </div>
      <div style={{ position: 'absolute', top: '500px', left: '20px', color: 'white' }}>
        <h2>ä¸Šä¼ å›¾ç‰‡</h2>
        <ImageUploader />
      </div>
    </div>
  );
}

export default App;
#ä¸–ç•Œåœ°å›¾èƒŒæ™¯#
import React from 'react';
import { MapContainer, TileLayer } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';

function WorldMap() {
  return (
    <MapContainer center={[0, 0]} zoom={2} style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100vh', zIndex: -1 }}>
      <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
    </MapContainer>
  );
}
export default WorldMap;
#å±•ç¤ºä¸ªäººä¿¡æ¯#
import React, { useState } from 'react';

function UserProfile() {
  const [intro, setIntro] = useState('ä½œè€…å¸Œæœ›åœ¨è¿™é‡Œè®°å½•å¯¹å…¨çƒå®è§‚å˜åŠ¨çš„è§‚å¯Ÿ');

  const handleChange = (e) => {
    setIntro(e.target.value);
  };

  return (
    <div>
      <textarea
        value={intro}
        onChange={handleChange}
        rows="4"
        cols="50"
        style={{ width: '300px' }}
      />
    </div>
  );
}

export default UserProfile;
#å®è§‚è§£è¯»çš„å¯Œæ–‡æœ¬åŠŸèƒ½#
import React, { useState } from 'react';
import ReactQuill from 'react-quill';
import 'react-quill/dist/quill.snow.css';

function Editor() {
  const [content, setContent] = useState('');

  const handleChange = (value) => {
    setContent(value);
  };

  return (
    <div>
      <ReactQuill value={content} onChange={handleChange} />
    </div>
  );
}

export default Editor;
#å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½#
import React, { useState } from 'react';
import { FilePond } from 'react-filepond';
import 'filepond/dist/filepond.min.css';

function ImageUploader() {
  const [files, setFiles] = useState([]);
  
  const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:5000';
  console.log('å½“å‰APIåœ°å€:', API_URL);

  const handleUpdateFiles = (fileItems) => {
    setFiles(fileItems.map(fileItem => fileItem.file));
  };
const serverConfig = {
    process: {
      url: `${API_URL}/upload`,
      method: 'POST',
      withCredentials: false
    }
  };
  
  console.log('FilePond æœåŠ¡å™¨é…ç½®:', serverConfig);
  console.log('å®Œæ•´ä¸Šä¼ URL:', serverConfig.process.url);

  const handleUpdateFiles = (fileItems) => {
    setFiles(fileItems.map(fileItem => fileItem.file));
  };
  return (
    <div>
      <FilePond
        files={files}
        onupdatefiles={handleUpdateFiles}
        server={{
          process: {
            url: `${API_URL}/upload`,
            method: 'POST',
            withCredentials: false
          }
        }}
        name="image"
        labelIdle='æ‹–æ”¾æ–‡ä»¶æˆ– <span class="filepond--label-action">æµè§ˆ</span>'
      />
    </div>
  );
}

export default ImageUploader;

#åç«¯ä»£ç #
#åœ¨ backend æ–‡ä»¶å¤¹ä¸­ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Node.js é¡¹ç›®#
mkdir backend
cd backend
npm init -y
npm install express multer
#serve.js#
const express = require('express');
const multer = require('multer');
const cors = require('cors');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const app = express();

// âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±ç”¨é»˜è®¤å€¼
const PORT = process.env.PORT || 5000;
const JWT_SECRET = 'your-secret-key';  // ç”¨æ›´å¼ºçš„å¯†é’¥æ›¿æ¢è¿™ä¸ª

// âœ… é…ç½®CORSï¼Œå…è®¸å‰ç«¯è®¿é—®
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true
}));

// âœ… è§£æ JSON è¯·æ±‚ä½“
app.use(express.json());

// æ¨¡æ‹Ÿçš„ç”¨æˆ·æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥ä»æ•°æ®åº“è·å–ï¼‰
const users = [
  {
    username: 'admin',
    password: '$2a$10$kPqH02Um94fKbBhZ0YzVOi8q0ro/ogZ2Dpxs46cGpWeKgRWi0UwmS'  // è¿™æ˜¯åŠ å¯†åçš„ "password123"
  }
];

// âœ… ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆé¿å…äº‘å¹³å°æ–‡ä»¶ä¸¢å¤±é—®é¢˜ï¼‰
const storage = multer.memoryStorage();
const upload = multer({
  storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // é™åˆ¶5MB
  }
});

// âœ… JWT éªŒè¯ä¸­é—´ä»¶
const authenticateToken = (req, res, next) => {
  const token = req.headers['authorization']?.split(' ')[1];  // ä» Authorization å¤´ä¸­æå– token

  if (!token) {
    return res.status(403).json({ message: 'ç¼ºå°‘ tokenï¼Œè®¿é—®è¢«æ‹’ç»' });
  }

  jwt.verify(token, JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({ message: 'æ— æ•ˆçš„ tokenï¼Œè®¿é—®è¢«æ‹’ç»' });
    }
    req.user = user;  // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    next();  // ç»§ç»­æ‰§è¡Œåç»­çš„è·¯ç”±å¤„ç†
  });
};

// âœ… ç”¨æˆ·ç™»å½•æ¥å£ (ç”Ÿæˆ JWT token)
app.post('/login', (req, res) => {
  const { username, password } = req.body;

  // æŸ¥æ‰¾ç”¨æˆ·
  const user = users.find(u => u.username === username);
  if (!user) {
    return res.status(400).json({ message: 'ç”¨æˆ·ä¸å­˜åœ¨' });
  }

  // æ¯”å¯¹å¯†ç 
  bcrypt.compare(password, user.password, (err, isMatch) => {
    if (err) {
      return res.status(500).json({ message: 'å¯†ç éªŒè¯å¤±è´¥' });
    }

    if (!isMatch) {
      return res.status(400).json({ message: 'å¯†ç é”™è¯¯' });
    }

    // å¯†ç åŒ¹é…æˆåŠŸï¼Œç”Ÿæˆ JWT token
    const token = jwt.sign({ username: user.username }, JWT_SECRET, { expiresIn: '1h' });
    
    res.json({ token });  // è¿”å›ç”Ÿæˆçš„ token
  });
});

// âœ… ä¿æŠ¤çš„æ–‡ä»¶ä¸Šä¼ æ¥å£
app.post('/upload', authenticateToken, upload.single('image'), (req, res) => {
  if (!req.file) {
    return res.status(400).send('No file uploaded.');
  }
  res.json({
    fileUrl: 'https://via.placeholder.com/300',
    message: 'æ–‡ä»¶ä¸Šä¼ è¯·æ±‚å·²æ”¶åˆ°ï¼ˆå®é™…å­˜å‚¨åŠŸèƒ½å¾…å®ç°ï¼‰',
    filename: req.file.originalname,
    size: req.file.size
  });
});

// âœ… å¥åº·æ£€æŸ¥æ¥å£ï¼ˆé‡è¦ï¼ï¼‰
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    message: 'åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development'
  });
});

// âœ… æ ¹è·¯å¾„ä¹Ÿè¿”å›å¥åº·ä¿¡æ¯
app.get('/', (req, res) => {
  res.json({
    message: 'ä¸ªäººè®°å½•ç½‘ç«™åç«¯æœåŠ¡',
    version: '1.0.0',
    endpoints: {
      health: '/health',
      upload: '/upload',
      login: '/login'
    }
  });
});

// âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ç«¯å£
app.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
  console.log(`å¥åº·æ£€æŸ¥: http://localhost:${PORT}/health`);
  console.log(`å‰ç«¯åŸŸå: ${process.env.FRONTEND_URL || 'http://localhost:3000'}`);
});
#åˆ›å»ºä¸Šä¼ æ–‡ä»¶å¤¹#
mkdir uploads

#è¿æ¥å‰åç«¯#
#å®‰è£…cors#
npm install cors
#åœ¨serve.jsä¸­æ·»åŠ corsé…ç½®#
const cors = require('cors');
app.use(cors());
#å¯ç”¨åç«¯æœåŠ¡å™¨#
node backend/server.js
#å¯ç”¨å‰ç«¯reactåº”ç”¨!!å¿…é¡»åœ¨package.jsonæ ¹ç›®å½•ä¸‹è¿è¡Œ#
npm start
#è®¿é—®#
http://localhost:3000
